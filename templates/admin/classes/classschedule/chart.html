{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    .chart-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        margin: 20px 0;
        overflow: hidden;
    }
    
    .chart-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        text-align: center;
        position: relative;
    }
    
    .chart-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
    }
    
    .chart-header h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 700;
        position: relative;
        z-index: 1;
    }
    
    .chart-header p {
        margin: 8px 0 0 0;
        font-size: 16px;
        opacity: 0.9;
        position: relative;
        z-index: 1;
    }
    
    .chart-controls {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px;
        border-bottom: 2px solid #dee2e6;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .chart-controls a {
        padding: 12px 18px;
        border: 2px solid #ced4da;
        border-radius: 8px;
        text-decoration: none;
        background: white;
        color: #495057;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .chart-controls a:hover {
        background: #e9ecef;
        border-color: #007bff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,123,255,0.15);
    }
    
    .time-category-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        font-weight: 700;
        text-align: center;
        padding: 8px;
        font-size: 13px;
        position: sticky;
        top: 0;
        z-index: 15;
    }
    
    .time-category-header.three-plus {
        background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
        color: #212529;
    }
    
    .chart-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 12px;
        min-width: 900px;
        background: white;
    }
    
    .chart-table th {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 12px 8px;
        text-align: center;
        font-weight: 700;
        color: #495057;
        position: sticky;
        top: 0;
        z-index: 10;
        min-width: 100px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .chart-table td {
        border: 1px solid #dee2e6;
        padding: 4px;
        text-align: center;
        vertical-align: top;
        height: 80px;
        position: relative;
        background: #fafbfc;
    }
    
    .two-or-less-cell {
        min-width: 90px; /* Slightly narrower for 2- credit hours */
        background: linear-gradient(135deg, #f8fff8 0%, #f1f8e9 100%);
        border-left: 2px solid #4caf50;
        border-right: 1px solid rgba(76, 175, 80, 0.3);
    }
    
    .three-or-more-cell {
        min-width: 110px; /* Wider for 3+ credit hours */
        background: linear-gradient(135deg, #fffef7 0%, #fff8e1 100%);
        border-left: 2px solid #ff9800;
        border-right: 1px solid rgba(255, 152, 0, 0.3);
    }
    
    .dual-schedule-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        gap: 2px;
    }
    
    .schedule-line {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        position: relative;
        min-height: 35px;
    }
    
    .two-or-less-line {
        background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
        border: 1px solid #c8e6c9;
    }
    
    .three-or-more-line {
        background: linear-gradient(135deg, #fff3e0 0%, #fff8e1 100%);
        border: 1px solid #ffcc02;
    }
    
    .empty-line {
        background: transparent;
        color: #999;
        font-size: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
    
    .room-cell {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        font-weight: 700;
        color: #1565c0;
        width: 80px;
        min-width: 80px;
        position: sticky;
        left: 0;
        z-index: 5;
        box-shadow: 2px 0 4px rgba(0,0,0,0.05);
        border-right: 3px solid #2196f3;
    }
    
    .time-header {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        color: #1565c0;
        font-weight: 700;
        min-width: 100px;
        height: 70px;
        border-right: 2px solid #2196f3;
        position: relative;
        writing-mode: horizontal-tb;
        text-orientation: initial;
    }
    
    .time-header.two-or-less-header {
        background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
        color: #2e7d32;
        border-right: 2px solid #4caf50;
        min-width: 90px; /* Slightly narrower for 2- credit hours */
    }
    
    .time-header.three-or-more-header {
        background: linear-gradient(135deg, #fff3e0 0%, #fff8e1 100%);
        color: #f57c00;
        border-right: 2px solid #ff9800;
        min-width: 110px; /* Wider for 3+ credit hours */
    }
    
    .time-slot-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        gap: 4px;
        padding: 6px;
    }
    
    .time-text {
        font-weight: 700;
        font-size: 10px;
        text-align: center;
        line-height: 1.2;
    }
    
    .credit-indicator {
        font-size: 8px;
        padding: 2px 6px;
        border-radius: 10px;
        text-align: center;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.8);
    }
    
    .two-or-less-header .credit-indicator {
        background: rgba(76, 175, 80, 0.2);
        color: #2e7d32;
    }
    
    .three-or-more-header .credit-indicator {
        background: rgba(255, 152, 0, 0.2);
        color: #f57c00;
    }
    
    .credit-lines {
        display: flex;
        flex-direction: column;
        gap: 2px;
        margin-top: 3px;
    }
    
    .credit-line {
        font-size: 7px;
        padding: 2px 4px;
        border-radius: 3px;
        text-align: center;
        font-weight: 600;
    }
    
    .credit-line.two-or-less {
        background: #e8f5e8;
        color: #2e7d32;
    }
    
    .credit-line.three-or-more {
        background: #fff3e0;
        color: #f57c00;
    }
    
    .time-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 60%;
        height: 3px;
        background: linear-gradient(90deg, transparent 0%, #2196f3 50%, transparent 100%);
    }
    
    .schedule-cell {
        background: #fafbfc;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 4px;
        border-radius: 4px;
    }
    
    .schedule-cell:hover {
        background: #e3f2fd;
        transform: scale(1.03);
        z-index: 8;
        box-shadow: 0 6px 20px rgba(33, 150, 243, 0.25);
        border: 2px solid #2196f3;
    }
    
    .schedule-cell:hover .schedule-line {
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .schedule-content {
        font-size: 7px;
        line-height: 1.3;
        padding: 3px;
        height: 100%;
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        position: relative;
        border-radius: 4px;
        transition: all 0.3s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        border: 1px solid rgba(0,0,0,0.1);
    }
    
    .schedule-content.occupied {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 2px solid #2196f3;
        box-shadow: 0 3px 8px rgba(33, 150, 243, 0.3);
    }
    
    .schedule-content.occupied:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
    }
    
    .schedule-content.not-holding {
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        border: 2px solid #f44336;
        box-shadow: 0 3px 8px rgba(244, 67, 54, 0.3);
    }
    
    .schedule-content.not-holding:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
    }
    
    .schedule-content.empty-line {
        background: transparent;
        color: #999;
        font-size: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        border: 1px dashed #ddd;
        border-radius: 4px;
    }
    
    .course-name {
        font-weight: 700;
        color: #1565c0;
        margin-bottom: 1px;
        font-size: 7px;
        line-height: 1.1;
        word-break: break-word;
    }
    
    .course-code {
        font-weight: 600;
        color: #1976d2;
        margin-bottom: 1px;
        font-size: 6px;
        background: rgba(25, 118, 210, 0.15);
        padding: 1px 4px;
        border-radius: 3px;
        border: 1px solid rgba(25, 118, 210, 0.3);
    }
    
    .teacher-name {
        color: #424242;
        font-size: 6px;
        margin-bottom: 1px;
        font-weight: 500;
        line-height: 1.1;
    }
    
    .course-code {
        color: #1976d2;
        font-size: 8px;
        font-family: 'Courier New', monospace;
        background: rgba(255,255,255,0.8);
        padding: 1px 3px;
        border-radius: 3px;
        font-weight: bold;
        margin-bottom: 1px;
    }
    
    .semester-info {
        color: #666;
        font-size: 7px;
        background: rgba(255,255,255,0.6);
        padding: 1px 3px;
        border-radius: 2px;
        margin-bottom: 1px;
    }
    
    .credit-hours {
        position: absolute;
        top: 3px;
        right: 3px;
        background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
        color: white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 8px;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
        border: 2px solid white;
    }
    
    .credit-hours.three-plus {
        background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
        box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);
    }
    
    .empty-cell {
        background: #f8f9fa;
        color: #6c757d;
        font-style: italic;
        font-size: 9px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .chart-legend {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px;
        border-top: 2px solid #dee2e6;
        display: flex;
        gap: 25px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        font-weight: 500;
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 2px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .legend-color.occupied { 
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-color: #2196f3;
    }
    .legend-color.not-holding { 
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        border-color: #f44336;
    }
    .legend-color.empty { 
        background: #f8f9fa;
        border-color: #6c757d;
    }
    
    .chart-actions {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px;
        border-top: 2px solid #dee2e6;
        text-align: center;
    }
    
    .chart-actions a {
        display: inline-block;
        padding: 12px 24px;
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        margin: 0 8px;
        transition: all 0.3s ease;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
    
    .chart-actions a:hover {
        background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
    }
    
    .chart-actions a.secondary {
        background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }
    
    .chart-actions a.secondary:hover {
        background: linear-gradient(135deg, #545b62 0%, #343a40 100%);
        box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
    }
    
    .table-container {
        overflow-x: auto;
        max-height: 75vh;
        overflow-y: auto;
        background: white;
        border-radius: 0 0 12px 12px;
    }
    
    /* Popup Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(5px);
    }
    
    .modal-content {
        background: white;
        margin: 2% auto;
        padding: 0;
        border-radius: 12px;
        width: 95%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        animation: modalSlideIn 0.3s ease-out;
        display: flex;
        flex-direction: column;
    }
    
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-header h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
    }
    
    .close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: opacity 0.3s ease;
    }
    
    .close:hover {
        opacity: 0.7;
    }
    
    .modal-body {
        padding: 20px;
        flex: 1;
        overflow-y: auto;
        max-height: calc(90vh - 140px);
        scrollbar-width: thin;
        scrollbar-color: #667eea #f1f1f1;
    }
    
    .modal-body::-webkit-scrollbar {
        width: 6px;
    }
    
    .modal-body::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .modal-body::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 3px;
    }
    
    .modal-body::-webkit-scrollbar-thumb:hover {
        background: #5a6fd8;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .modal-actions {
        padding: 15px 20px;
        border-top: 1px solid #e9ecef;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        flex-wrap: wrap;
        background: #f8f9fa;
        border-radius: 0 0 12px 12px;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        min-width: 100px;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #545b62;
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }
    
    .btn-danger:hover {
        background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
    }
    
    @media (max-width: 768px) {
        .chart-table {
            font-size: 10px;
        }
        
        .chart-table td {
            min-width: 80px;
            height: 55px;
        }
        
        .room-cell {
            min-width: 60px;
        }
        
        .schedule-content {
            font-size: 8px;
        }
        
        .chart-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .chart-controls a {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .modal-content {
            width: 98%;
            margin: 1% auto;
            max-height: 98vh;
        }
        
        .modal-body {
            padding: 15px;
            max-height: calc(98vh - 120px);
        }
        
        .modal-actions {
            padding: 10px 15px;
            flex-direction: column;
        }
        
        .btn {
            width: 100%;
            margin-bottom: 8px;
            padding: 12px;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        .modal-body div[style*="grid-template-columns"] {
            grid-template-columns: 1fr !important;
            gap: 12px !important;
        }
    }
    
    @media (max-width: 480px) {
        .modal-content {
            width: 100%;
            margin: 0;
            border-radius: 0;
            max-height: 100vh;
        }
        
        .modal-header {
            padding: 15px;
        }
        
        .modal-header h2 {
            font-size: 18px;
        }
        
        .modal-body {
            padding: 10px;
            max-height: calc(100vh - 140px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chart-container">
    <div class="chart-header">
        <h1>{{ title }}</h1>
        <p>نمودار برنامه کلاسی - نمایش بصری برنامه‌های درسی</p>
        {% if selected_day and selected_floor %}
            <p>روز: {{ selected_day|title }} - طبقه: {{ selected_floor }}</p>
        {% elif selected_day %}
            <p>روز: {{ selected_day|title }}</p>
        {% endif %}
    </div>
    
    <div class="chart-controls">
        <a href="{% url 'admin:classes_classschedule_day_selection' %}">انتخاب روز و طبقه</a>
        <a href="{% url 'admin:classes_classschedule_chart' %}">نمایش همه</a>
        <a href="{% url 'admin:classes_classschedule_changelist' %}">لیست برنامه‌ها</a>
    </div>
    
    <div class="table-container">
        <table class="chart-table">
            <thead>
                <!-- Time slots organized by credit hours -->
                <tr>
                    <th class="room-cell">اتاق</th>
                    <!-- ≤2 credit hours time slots -->
                    {% for time_slot in time_slots_2_or_less %}
                        <th class="time-header two-or-less-header">
                            <div class="time-slot-info">
                                <div class="time-text">{{ time_slot.1 }}</div>
                                <div class="credit-indicator">≤2 واحد</div>
                            </div>
                        </th>
                    {% endfor %}
                    <!-- ≥3 credit hours time slots -->
                    {% for time_slot in time_slots_3_or_more %}
                        <th class="time-header three-or-more-header">
                            <div class="time-slot-info">
                                <div class="time-text">{{ time_slot.1 }}</div>
                                <div class="credit-indicator">≥3 واحد</div>
                            </div>
                        </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for room in rooms %}
                    <tr>
                        <td class="room-cell">
                            <div class="room-info">
                            <strong>{{ room.room_number }}</strong><br>
                            <small>طبقه {{ room.floor.floor_number }}</small>
                                <div class="room-type">{{ room.get_room_type_display }}</div>
                            </div>
                        </td>
                        <!-- ≤2 credit hours columns -->
                        {% for time_slot in time_slots_2_or_less %}
                            <td class="schedule-cell two-or-less-cell" 
                                data-room="{{ room.id }}" 
                                data-day="{{ selected_day }}" 
                                data-time-slot="{{ time_slot.0 }}"
                                data-room-number="{{ room.room_number }}"
                                data-floor="{{ room.floor.floor_number }}"
                                onclick="openScheduleModal(this)">
                                
                                {% if selected_day %}
                                    {% for schedule in schedules %}
                                        {% if schedule.day_of_week == selected_day and schedule.room.id == room.id and schedule.course.credit_hours <= 2 %}
                                            {% if schedule.start_time and schedule.end_time %}
                                                {% if schedule.start_time|time:"H:i" == time_slot.0|slice:":5" and schedule.end_time|time:"H:i" == time_slot.0|slice:"6:" %}
                                                    <div class="schedule-content occupied {% if not schedule.is_holding %}not-holding{% endif %}">
                                                        <div class="course-code">{{ schedule.course.course_code }}</div>
                                                        <div class="course-name">{{ schedule.course.course_name }}</div>
                                                        <div class="teacher-name">{{ schedule.teacher.full_name }}</div>
                                                        {% if schedule.semester %}
                                                        <div class="semester-info">{{ schedule.semester }}</div>
                                                        {% endif %}
                                                        <div class="credit-hours">{{ schedule.course.credit_hours }}</div>
                                                        <input type="hidden" class="schedule-data" 
                                                               data-schedule-id="{{ schedule.id }}"
                                                               data-course-id="{{ schedule.course.id }}"
                                                               data-course-name="{{ schedule.course.course_name }}"
                                                               data-course-code="{{ schedule.course.course_code }}"
                                                               data-teacher-id="{{ schedule.teacher.id }}"
                                                               data-teacher-name="{{ schedule.teacher.full_name }}"
                                                               data-credit="{{ schedule.course.credit_hours }}"
                                                               data-holding="{{ schedule.is_holding }}"
                                                               data-semester="{{ schedule.semester }}"
                                                               data-academic-year="{{ schedule.academic_year }}"
                                                               data-notes="{{ schedule.notes }}"
                                                               data-start-time="{{ schedule.start_time|time:'H:i' }}"
                                                               data-end-time="{{ schedule.end_time|time:'H:i' }}">
                                                    </div>
                                                {% endif %}
                                            {% else %}
                                                {% if schedule.time_slot == time_slot.0 %}
                                                    <div class="schedule-content occupied {% if not schedule.is_holding %}not-holding{% endif %}">
                                                        <div class="course-code">{{ schedule.course.course_code }}</div>
                                                        <div class="course-name">{{ schedule.course.course_name }}</div>
                                                        <div class="teacher-name">{{ schedule.teacher.full_name }}</div>
                                                        {% if schedule.semester %}
                                                        <div class="semester-info">{{ schedule.semester }}</div>
                                                        {% endif %}
                                                        <div class="credit-hours">{{ schedule.course.credit_hours }}</div>
                                                        <input type="hidden" class="schedule-data" 
                                                               data-schedule-id="{{ schedule.id }}"
                                                               data-course-id="{{ schedule.course.id }}"
                                                               data-course-name="{{ schedule.course.course_name }}"
                                                               data-course-code="{{ schedule.course.course_code }}"
                                                               data-teacher-id="{{ schedule.teacher.id }}"
                                                               data-teacher-name="{{ schedule.teacher.full_name }}"
                                                               data-credit="{{ schedule.course.credit_hours }}"
                                                               data-holding="{{ schedule.is_holding }}"
                                                               data-semester="{{ schedule.semester }}"
                                                               data-academic-year="{{ schedule.academic_year }}"
                                                               data-notes="{{ schedule.notes }}"
                                                               data-start-time="{{ schedule.start_time|time:'H:i' }}"
                                                               data-end-time="{{ schedule.end_time|time:'H:i' }}">
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if not schedules %}
                                        <div class="schedule-content empty-line">
                                            <small>خالی</small>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="schedule-content empty-line">
                                        <small>خالی</small>
                                    </div>
                                {% endif %}
                            </td>
                        {% endfor %}
                        
                        <!-- ≥3 credit hours columns -->
                        {% for time_slot in time_slots_3_or_more %}
                            <td class="schedule-cell three-or-more-cell" 
                                data-room="{{ room.id }}" 
                                data-day="{{ selected_day }}" 
                                data-time-slot="{{ time_slot.0 }}"
                                data-room-number="{{ room.room_number }}"
                                data-floor="{{ room.floor.floor_number }}"
                                onclick="openScheduleModal(this)">
                                
                                {% if selected_day %}
                                    {% for schedule in schedules %}
                                        {% if schedule.day_of_week == selected_day and schedule.room.id == room.id and schedule.course.credit_hours >= 3 %}
                                            {% if schedule.start_time and schedule.end_time %}
                                                {% if schedule.start_time|time:"H:i" == time_slot.0|slice:":5" and schedule.end_time|time:"H:i" == time_slot.0|slice:"6:" %}
                                                    <div class="schedule-content occupied {% if not schedule.is_holding %}not-holding{% endif %}">
                                                        <div class="course-code">{{ schedule.course.course_code }}</div>
                                                        <div class="course-name">{{ schedule.course.course_name }}</div>
                                                        <div class="teacher-name">{{ schedule.teacher.full_name }}</div>
                                                        {% if schedule.semester %}
                                                        <div class="semester-info">{{ schedule.semester }}</div>
                                                        {% endif %}
                                                        <div class="credit-hours three-plus">{{ schedule.course.credit_hours }}</div>
                                                        <input type="hidden" class="schedule-data" 
                                                               data-schedule-id="{{ schedule.id }}"
                                                               data-course-id="{{ schedule.course.id }}"
                                                               data-course-name="{{ schedule.course.course_name }}"
                                                               data-course-code="{{ schedule.course.course_code }}"
                                                               data-teacher-id="{{ schedule.teacher.id }}"
                                                               data-teacher-name="{{ schedule.teacher.full_name }}"
                                                               data-credit="{{ schedule.course.credit_hours }}"
                                                               data-holding="{{ schedule.is_holding }}"
                                                               data-semester="{{ schedule.semester }}"
                                                               data-academic-year="{{ schedule.academic_year }}"
                                                               data-notes="{{ schedule.notes }}"
                                                               data-start-time="{{ schedule.start_time|time:'H:i' }}"
                                                               data-end-time="{{ schedule.end_time|time:'H:i' }}">
                                                    </div>
                                                {% endif %}
                                            {% else %}
                                                {% if schedule.time_slot == time_slot.0 %}
                                                    <div class="schedule-content occupied {% if not schedule.is_holding %}not-holding{% endif %}">
                                                        <div class="course-code">{{ schedule.course.course_code }}</div>
                                                        <div class="course-name">{{ schedule.course.course_name }}</div>
                                                        <div class="teacher-name">{{ schedule.teacher.full_name }}</div>
                                                        {% if schedule.semester %}
                                                        <div class="semester-info">{{ schedule.semester }}</div>
                                                        {% endif %}
                                                        <div class="credit-hours three-plus">{{ schedule.course.credit_hours }}</div>
                                                        <input type="hidden" class="schedule-data" 
                                                               data-schedule-id="{{ schedule.id }}"
                                                               data-course-id="{{ schedule.course.id }}"
                                                               data-course-name="{{ schedule.course.course_name }}"
                                                               data-course-code="{{ schedule.course.course_code }}"
                                                               data-teacher-id="{{ schedule.teacher.id }}"
                                                               data-teacher-name="{{ schedule.teacher.full_name }}"
                                                               data-credit="{{ schedule.course.credit_hours }}"
                                                               data-holding="{{ schedule.is_holding }}"
                                                               data-semester="{{ schedule.semester }}"
                                                               data-academic-year="{{ schedule.academic_year }}"
                                                               data-notes="{{ schedule.notes }}"
                                                               data-start-time="{{ schedule.start_time|time:'H:i' }}"
                                                               data-end-time="{{ schedule.end_time|time:'H:i' }}">
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if not schedules %}
                                        <div class="schedule-content empty-line">
                                            <small>خالی</small>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="schedule-content empty-line">
                                        <small>خالی</small>
                                    </div>
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="chart-legend">
        <div class="legend-item">
            <div class="legend-color occupied"></div>
            <span>کلاس برگزار می‌شود</span>
        </div>
        <div class="legend-item">
            <div class="legend-color not-holding"></div>
            <span>کلاس برگزار نمی‌شود</span>
        </div>
        <div class="legend-item">
            <div class="legend-color empty"></div>
            <span>خالی</span>
        </div>
        <div class="legend-item">
            <div style="display: flex; flex-direction: column; gap: 3px;">
                <div style="background: #e8f5e8; color: #2e7d32; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">≤2 واحد (ستون‌های سبز)</div>
                <div style="background: #fff3e0; color: #f57c00; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">≥3 واحد (ستون‌های نارنجی)</div>
            </div>
            <span style="margin-left: 15px; font-size: 12px; font-weight: 600;">نوع واحدهای درسی</span>
        </div>
    </div>
    
    <div class="chart-actions">
        <a href="{% url 'admin:classes_classschedule_add' %}">افزودن برنامه جدید</a>
        <a href="{% url 'admin:classes_classschedule_changelist' %}" class="secondary">مدیریت برنامه‌ها</a>
        <a href="{% url 'admin:classes_course_changelist' %}" class="secondary">مدیریت دروس</a>
        <a href="{% url 'admin:classes_teacher_changelist' %}" class="secondary">مدیریت اساتید</a>
    </div>
</div>

<!-- Schedule Modification Modal -->
<div id="scheduleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>مدیریت برنامه کلاسی</h2>
            <span class="close" onclick="closeScheduleModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="scheduleForm" method="post">
                {% csrf_token %}
                <input type="hidden" id="scheduleId" name="schedule_id">
                <input type="hidden" id="roomId" name="room_id">
                <input type="hidden" id="dayOfWeek" name="day_of_week">
                <input type="hidden" id="timeSlot" name="time_slot">
                
                <div class="form-group">
                    <label>اطلاعات زمان و مکان:</label>
                    <div id="scheduleInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>اتاق:</strong> <span id="roomInfo"></span><br>
                        <strong>روز:</strong> <span id="dayInfo"></span><br>
                        <strong>زمان:</strong> <span id="timeInfo"></span><br>
                        <div id="existingScheduleInfo" style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px; display: none;">
                            <strong>برنامه موجود:</strong><br>
                            <span id="existingCourse"></span><br>
                            <span id="existingTeacher"></span><br>
                            <span id="existingSemester"></span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="courseSelect">درس:</label>
                    <select id="courseSelect" name="course" required>
                        <option value="">انتخاب درس...</option>
                        {% for course in courses %}
                            <option value="{{ course.id }}">{{ course.course_name }} ({{ course.course_code }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="teacherSelect">استاد:</label>
                    <select id="teacherSelect" name="teacher" required>
                        <option value="">انتخاب استاد...</option>
                        {% for teacher in teachers %}
                            <option value="{{ teacher.id }}">{{ teacher.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="startTime">ساعت شروع:</label>
                        <input type="time" id="startTime" name="start_time" placeholder="مثال: 07:30">
                    </div>
                    
                    <div class="form-group">
                        <label for="endTime">ساعت پایان:</label>
                        <input type="time" id="endTime" name="end_time" placeholder="مثال: 09:15">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="semester">نیمسال:</label>
                        <input type="text" id="semester" name="semester" placeholder="مثال: 1403-1">
                    </div>
                    
                    <div class="form-group">
                        <label for="academicYear">سال تحصیلی:</label>
                        <input type="text" id="academicYear" name="academic_year" placeholder="مثال: 1403-1404">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="isHolding">وضعیت برگزاری:</label>
                    <select id="isHolding" name="is_holding">
                        <option value="true">کلاس برگزار می‌شود</option>
                        <option value="false">کلاس برگزار نمی‌شود</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="notes">یادداشت‌ها:</label>
                    <textarea id="notes" name="notes" rows="2" placeholder="یادداشت‌های اضافی..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeScheduleModal()">لغو</button>
            <button type="button" class="btn btn-primary" onclick="saveSchedule()">ذخیره تغییرات</button>
            <button type="button" class="btn btn-danger" onclick="deleteSchedule()" id="deleteBtn" style="display: none;">حذف برنامه</button>
        </div>
    </div>
</div>

<script>
// Modal functionality
function openScheduleModal(cell) {
    const modal = document.getElementById('scheduleModal');
    // Find the first schedule data in the cell (either line)
    const scheduleData = cell.querySelector('.schedule-data');
    
    // Fill basic info
    document.getElementById('roomInfo').textContent = cell.dataset.roomNumber + ' (طبقه ' + cell.dataset.floor + ')';
    document.getElementById('dayInfo').textContent = getDayName(cell.dataset.day);
    document.getElementById('timeInfo').textContent = getTimeDisplay(cell.dataset.time);
    
    // Fill form fields
    document.getElementById('roomId').value = cell.dataset.room;
    document.getElementById('dayOfWeek').value = cell.dataset.day;
    document.getElementById('timeSlot').value = cell.dataset.time;
    
    if (scheduleData) {
        // Existing schedule - fill form
        document.getElementById('scheduleId').value = scheduleData.dataset.scheduleId;
        document.getElementById('courseSelect').value = scheduleData.dataset.courseId || '';
        document.getElementById('teacherSelect').value = scheduleData.dataset.teacherId || '';
        document.getElementById('semester').value = scheduleData.dataset.semester || '';
        document.getElementById('academicYear').value = scheduleData.dataset.academicYear || '';
        document.getElementById('isHolding').value = scheduleData.dataset.holding;
        document.getElementById('notes').value = scheduleData.dataset.notes || '';
        
        // Fill time fields if available
        if (scheduleData.dataset.startTime) {
            document.getElementById('startTime').value = scheduleData.dataset.startTime;
        }
        if (scheduleData.dataset.endTime) {
            document.getElementById('endTime').value = scheduleData.dataset.endTime;
        }
        
        document.getElementById('deleteBtn').style.display = 'inline-block';
        
        // Show existing schedule info
        document.getElementById('existingCourse').textContent = scheduleData.dataset.courseCode + ' - ' + scheduleData.dataset.courseName;
        document.getElementById('existingTeacher').textContent = 'استاد: ' + scheduleData.dataset.teacherName;
        document.getElementById('existingSemester').textContent = scheduleData.dataset.semester ? 'نیمسال: ' + scheduleData.dataset.semester : '';
        document.getElementById('existingScheduleInfo').style.display = 'block';
        
        // Disable course selection for existing schedules
        document.getElementById('courseSelect').disabled = true;
        document.getElementById('courseSelect').style.background = '#f8f9fa';
    } else {
        // New schedule - clear form
        document.getElementById('scheduleId').value = '';
        document.getElementById('courseSelect').value = '';
        document.getElementById('teacherSelect').value = '';
        document.getElementById('semester').value = '';
        document.getElementById('academicYear').value = '';
        document.getElementById('isHolding').value = 'true';
        document.getElementById('notes').value = '';
        document.getElementById('startTime').value = '';
        document.getElementById('endTime').value = '';
        document.getElementById('deleteBtn').style.display = 'none';
        
        // Hide existing schedule info for new schedules
        document.getElementById('existingScheduleInfo').style.display = 'none';
        
        // Enable course selection for new schedules
        document.getElementById('courseSelect').disabled = false;
        document.getElementById('courseSelect').style.background = 'white';
    }
    
    modal.style.display = 'block';
}

function closeScheduleModal() {
    document.getElementById('scheduleModal').style.display = 'none';
}

function saveSchedule() {
    const form = document.getElementById('scheduleForm');
    const formData = new FormData(form);
    
    fetch('{% url "admin:classes_classschedule_save" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('برنامه با موفقیت ذخیره شد');
            closeScheduleModal();
            location.reload();
        } else {
            alert('خطا در ذخیره: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('خطا در ارتباط با سرور');
    });
}

function deleteSchedule() {
    if (confirm('آیا از حذف این برنامه اطمینان دارید؟')) {
        const scheduleId = document.getElementById('scheduleId').value;
        
        fetch('{% url "admin:classes_classschedule_delete" %}', {
            method: 'POST',
            body: JSON.stringify({
                'schedule_id': scheduleId
            }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('برنامه با موفقیت حذف شد');
                closeScheduleModal();
                location.reload();
            } else {
                alert('خطا در حذف: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('خطا در ارتباط با سرور');
        });
    }
}

// Helper functions
function getDayName(dayValue) {
    const days = {
        'saturday': 'شنبه',
        'sunday': 'یکشنبه',
        'monday': 'دوشنبه',
        'tuesday': 'سه‌شنبه',
        'wednesday': 'چهارشنبه',
        'thursday': 'پنجشنبه',
        'friday': 'جمعه'
    };
    return days[dayValue] || dayValue;
}

function getTimeDisplay(timeValue) {
    // Handle both old time_slot format and new start_time-end_time format
    if (timeValue && timeValue.includes('-')) {
        const timeMap = {
            '07:30-09:15': '7:30-9:15',
            '09:15-11:00': '9:15-11:00',
            '11:00-13:15': '11:00-13:15',
            '13:15-15:00': '13:15-15:00',
            '15:00-16:45': '15:00-16:45',
            '16:45-18:00': '16:45-18:00',
            '07:30-10:10': '7:30-10:10',
            '10:15-13:30': '10:15-13:30',
            '13:30-16:00': '13:30-16:00',
            '16:00-18:30': '16:00-18:30'
        };
        return timeMap[timeValue] || timeValue;
    }
    return timeValue || 'زمان نامشخص';
}

// Helper functions removed - now using IDs directly from data attributes

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('scheduleModal');
    if (event.target == modal) {
        closeScheduleModal();
    }
}

// Add CSS for time slot info
const style = document.createElement('style');
style.textContent = `
    .time-slot-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 3px;
        padding: 4px;
    }
    
    .time-text {
        font-weight: 700;
        font-size: 9px;
        text-align: center;
        line-height: 1.1;
    }
    
    .credit-info {
        font-size: 8px;
        opacity: 0.8;
        font-weight: 500;
    }
    
    .room-info {
        text-align: center;
    }
    
    .room-type {
        font-size: 8px;
        color: #666;
        margin-top: 2px;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}